<!DOCTYPE html>
<html>
<head>
<title>TP2_DevSecOps_Docker_Securisation.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="tp-2---s%C3%A9curiser-le-pipeline-docker-cicd">TP 2 - Sécuriser le Pipeline Docker CI/CD</h1>
<h2 id="devsecops-avec-scan-de-containers">DevSecOps avec Scan de Containers</h2>
<p><strong>Prérequis :</strong> TP1 terminé, image Docker publiée sur GHCR</p>
<hr>
<h2 id="objectifs-du-tp">Objectifs du TP</h2>
<p>À l'issue de ce TP, vous serez capable de :</p>
<ul>
<li>Scanner des images Docker pour détecter les vulnérabilités</li>
<li>Intégrer Trivy dans le pipeline CI/CD</li>
<li>Configurer CodeQL pour l'analyse du code</li>
<li>Activer Dependabot pour les dépendances</li>
<li>Implémenter des Security Gates pour les images Docker</li>
<li>Corriger les vulnérabilités détectées dans les containers</li>
</ul>
<hr>
<h2 id="pr%C3%A9requis">Prérequis</h2>
<ul>
<li>TP1 terminé avec image Docker publiée</li>
<li>Pipeline GitHub Actions fonctionnel</li>
<li>Repository avec Dockerfile</li>
<li>Comprendre les concepts SAST, SCA, Container Security</li>
</ul>
<hr>
<h2 id="architecture-du-pipeline-devsecops">Architecture du Pipeline DevSecOps</h2>
<pre class="hljs"><code><div>Code Push
    |
    v
[Secret Scanning] --&gt; Blocage si secret
    |
    v
[Security Analysis Job]
    |
    +-- CodeQL (SAST code source)
    +-- Hadolint (Lint Dockerfile)
    |
    v
[Build Docker Image]
    |
    v
[Security Scan Job]
    |
    +-- Trivy (Scan image)
    +-- Grype (Scan vulnérabilités)
    +-- Security Gates
    |
    v
[Push to GHCR] --&gt; Si sécurité OK
</div></code></pre>
<hr>
<h2 id="%C3%A9tape-1--activer-codeql-pour-le-code-source">Étape 1 : Activer CodeQL pour le Code Source</h2>
<h3 id="11-configuration-automatique">1.1 Configuration automatique</h3>
<ol>
<li>Aller sur votre repository GitHub</li>
<li><strong>Security</strong> &gt; <strong>Code scanning</strong></li>
<li><strong>Set up code scanning</strong> &gt; <strong>CodeQL Analysis</strong></li>
<li><strong>Configure CodeQL</strong></li>
</ol>
<p>GitHub créera <code>.github/workflows/codeql-analysis.yml</code></p>
<h3 id="12-v%C3%A9rifier-le-workflow-codeql">1.2 Vérifier le workflow CodeQL</h3>
<pre class="hljs"><code><div><span class="hljs-attr">name:</span> <span class="hljs-string">"CodeQL"</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> <span class="hljs-string">[</span> <span class="hljs-string">main</span> <span class="hljs-string">]</span>
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">branches:</span> <span class="hljs-string">[</span> <span class="hljs-string">main</span> <span class="hljs-string">]</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">analyze:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">Analyze</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">actions:</span> <span class="hljs-string">read</span>
      <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>
      <span class="hljs-attr">security-events:</span> <span class="hljs-string">write</span>

    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-attr">language:</span> <span class="hljs-string">[</span> <span class="hljs-string">'javascript'</span> <span class="hljs-string">]</span>

    <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Initialize</span> <span class="hljs-string">CodeQL</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">github/codeql-action/init@v2</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-attr">languages:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.language</span> <span class="hljs-string">}}</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Autobuild</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">github/codeql-action/autobuild@v2</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Perform</span> <span class="hljs-string">CodeQL</span> <span class="hljs-string">Analysis</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">github/codeql-action/analyze@v2</span>
</div></code></pre>
<hr>
<h2 id="%C3%A9tape-2--configurer-dependabot">Étape 2 : Configurer Dependabot</h2>
<h3 id="21-cr%C3%A9er-githubdependabotyml">2.1 Créer .github/dependabot.yml</h3>
<pre class="hljs"><code><div><span class="hljs-attr">version:</span> <span class="hljs-number">2</span>
<span class="hljs-attr">updates:</span>
  <span class="hljs-comment"># Surveiller les dépendances npm</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">package-ecosystem:</span> <span class="hljs-string">"npm"</span>
    <span class="hljs-attr">directory:</span> <span class="hljs-string">"/"</span>
    <span class="hljs-attr">schedule:</span>
      <span class="hljs-attr">interval:</span> <span class="hljs-string">"weekly"</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"dependencies"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"security"</span>

  <span class="hljs-comment"># Surveiller les actions GitHub</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">package-ecosystem:</span> <span class="hljs-string">"github-actions"</span>
    <span class="hljs-attr">directory:</span> <span class="hljs-string">"/"</span>
    <span class="hljs-attr">schedule:</span>
      <span class="hljs-attr">interval:</span> <span class="hljs-string">"weekly"</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"dependencies"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"github-actions"</span>

  <span class="hljs-comment"># Surveiller l'image de base Docker</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">package-ecosystem:</span> <span class="hljs-string">"docker"</span>
    <span class="hljs-attr">directory:</span> <span class="hljs-string">"/"</span>
    <span class="hljs-attr">schedule:</span>
      <span class="hljs-attr">interval:</span> <span class="hljs-string">"weekly"</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"dependencies"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"docker"</span>
</div></code></pre>
<h3 id="22-ajouter-un-packagejson-pour-tester">2.2 Ajouter un package.json (pour tester)</h3>
<p>Créer <code>package.json</code> à la racine :</p>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"devops-tp-docker"</span>,
  <span class="hljs-attr">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-attr">"description"</span>: <span class="hljs-string">"TP DevSecOps avec Docker"</span>,
  <span class="hljs-attr">"scripts"</span>: {
    <span class="hljs-attr">"test"</span>: <span class="hljs-string">"echo \"No tests yet\""</span>
  },
  <span class="hljs-attr">"dependencies"</span>: {
    <span class="hljs-attr">"express"</span>: <span class="hljs-string">"4.17.1"</span>,
    <span class="hljs-attr">"lodash"</span>: <span class="hljs-string">"4.17.20"</span>
  },
  <span class="hljs-attr">"devDependencies"</span>: {
    <span class="hljs-attr">"eslint"</span>: <span class="hljs-string">"7.32.0"</span>
  }
}
</div></code></pre>
<p><strong>Note :</strong> Versions anciennes volontairement pour détecter des vulnérabilités.</p>
<hr>
<h2 id="%C3%A9tape-3--activer-secret-scanning">Étape 3 : Activer Secret Scanning</h2>
<h3 id="31-activation">3.1 Activation</h3>
<ol>
<li><strong>Settings</strong> &gt; <strong>Code security and analysis</strong></li>
<li>Activer :
<ul>
<li><strong>Secret scanning</strong></li>
<li><strong>Push protection</strong> (recommandé)</li>
</ul>
</li>
</ol>
<h3 id="32-test-de-blocage">3.2 Test de blocage</h3>
<p>Créer <code>test-secret.txt</code> :</p>
<pre class="hljs"><code><div>github_token=ghp_ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890
aws_access_key=AKIAIOSFODNN7EXAMPLE
</div></code></pre>
<p>Tenter de pusher :</p>
<pre class="hljs"><code><div>git add <span class="hljs-built_in">test</span>-secret.txt
git commit -m <span class="hljs-string">"Test secret detection"</span>
git push
</div></code></pre>
<p>Le push doit être bloqué.</p>
<h3 id="33-nettoyage">3.3 Nettoyage</h3>
<pre class="hljs"><code><div>git rm <span class="hljs-built_in">test</span>-secret.txt
git reset --hard HEAD~1
</div></code></pre>
<hr>
<h2 id="%C3%A9tape-4--ajouter-hadolint-pour-le-dockerfile">Étape 4 : Ajouter Hadolint pour le Dockerfile</h2>
<h3 id="41-quest-ce-que-hadolint">4.1 Qu'est-ce que Hadolint ?</h3>
<p>Hadolint est un linter pour Dockerfile qui :</p>
<ul>
<li>Vérifie les bonnes pratiques Docker</li>
<li>Détecte les problèmes de sécurité</li>
<li>Suggère des optimisations</li>
</ul>
<h3 id="42-cr%C3%A9er-hadolintyaml">4.2 Créer .hadolint.yaml</h3>
<pre class="hljs"><code><div><span class="hljs-attr">ignored:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">DL3018</span>  <span class="hljs-comment"># Ignorer warning sur les versions pinnées Alpine</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">DL3008</span>  <span class="hljs-comment"># Ignorer warning sur les versions pinnées apt</span>

<span class="hljs-attr">trustedRegistries:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">docker.io</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">ghcr.io</span>

<span class="hljs-attr">failure-threshold:</span> <span class="hljs-string">warning</span>
</div></code></pre>
<h3 id="43-tester-localement">4.3 Tester localement</h3>
<pre class="hljs"><code><div>docker run --rm -i hadolint/hadolint &lt; Dockerfile
</div></code></pre>
<hr>
<h2 id="%C3%A9tape-5--int%C3%A9grer-trivy-dans-le-pipeline">Étape 5 : Intégrer Trivy dans le Pipeline</h2>
<h3 id="51-quest-ce-que-trivy">5.1 Qu'est-ce que Trivy ?</h3>
<p>Trivy est un scanner de vulnérabilités pour :</p>
<ul>
<li>Images Docker</li>
<li>Système de fichiers</li>
<li>Dépendances</li>
</ul>
<h3 id="52-modifier-le-workflow-docker-deployyml">5.2 Modifier le workflow docker-deploy.yml</h3>
<p>Remplacer le contenu par :</p>
<pre class="hljs"><code><div><span class="hljs-attr">name:</span> <span class="hljs-string">Build,</span> <span class="hljs-string">Scan</span> <span class="hljs-string">and</span> <span class="hljs-string">Push</span> <span class="hljs-string">Docker</span> <span class="hljs-string">Image</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> <span class="hljs-string">[</span> <span class="hljs-string">main</span> <span class="hljs-string">]</span>
    <span class="hljs-attr">tags:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">'v*'</span>
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">branches:</span> <span class="hljs-string">[</span> <span class="hljs-string">main</span> <span class="hljs-string">]</span>

<span class="hljs-attr">env:</span>
  <span class="hljs-attr">REGISTRY:</span> <span class="hljs-string">ghcr.io</span>
  <span class="hljs-attr">IMAGE_NAME:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.repository</span> <span class="hljs-string">}}</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">security-analysis:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">Security</span> <span class="hljs-string">Analysis</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>
      <span class="hljs-attr">security-events:</span> <span class="hljs-string">write</span>

    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">Hadolint</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">hadolint/hadolint-action@v3.1.0</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">./Dockerfile</span>
          <span class="hljs-attr">failure-threshold:</span> <span class="hljs-string">warning</span>

  <span class="hljs-attr">build-and-scan:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">and</span> <span class="hljs-string">Security</span> <span class="hljs-string">Scan</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">security-analysis</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>
      <span class="hljs-attr">packages:</span> <span class="hljs-string">write</span>
      <span class="hljs-attr">security-events:</span> <span class="hljs-string">write</span>

    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Docker</span> <span class="hljs-string">Buildx</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/setup-buildx-action@v2</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">Docker</span> <span class="hljs-string">image</span> <span class="hljs-string">for</span> <span class="hljs-string">scanning</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/build-push-action@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">context:</span> <span class="hljs-string">.</span>
          <span class="hljs-attr">load:</span> <span class="hljs-literal">true</span>
          <span class="hljs-attr">tags:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.IMAGE_NAME</span> <span class="hljs-string">}}:scan</span>
          <span class="hljs-attr">cache-from:</span> <span class="hljs-string">type=gha</span>
          <span class="hljs-attr">cache-to:</span> <span class="hljs-string">type=gha,mode=max</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">Trivy</span> <span class="hljs-string">vulnerability</span> <span class="hljs-string">scanner</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">aquasecurity/trivy-action@master</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">image-ref:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.IMAGE_NAME</span> <span class="hljs-string">}}:scan</span>
          <span class="hljs-attr">format:</span> <span class="hljs-string">'sarif'</span>
          <span class="hljs-attr">output:</span> <span class="hljs-string">'trivy-results.sarif'</span>
          <span class="hljs-attr">severity:</span> <span class="hljs-string">'CRITICAL,HIGH,MEDIUM'</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">Trivy</span> <span class="hljs-string">results</span> <span class="hljs-string">to</span> <span class="hljs-string">GitHub</span> <span class="hljs-string">Security</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">github/codeql-action/upload-sarif@v2</span>
        <span class="hljs-attr">if:</span> <span class="hljs-string">always()</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">sarif_file:</span> <span class="hljs-string">'trivy-results.sarif'</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">Trivy</span> <span class="hljs-string">with</span> <span class="hljs-string">fail</span> <span class="hljs-string">on</span> <span class="hljs-string">CRITICAL/HIGH</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">aquasecurity/trivy-action@master</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">image-ref:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.IMAGE_NAME</span> <span class="hljs-string">}}:scan</span>
          <span class="hljs-attr">exit-code:</span> <span class="hljs-string">'1'</span>
          <span class="hljs-attr">ignore-unfixed:</span> <span class="hljs-literal">true</span>
          <span class="hljs-attr">severity:</span> <span class="hljs-string">'CRITICAL,HIGH'</span>

  <span class="hljs-attr">push-image:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">Push</span> <span class="hljs-string">Docker</span> <span class="hljs-string">Image</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">build-and-scan</span>
    <span class="hljs-attr">if:</span> <span class="hljs-string">github.event_name</span> <span class="hljs-string">!=</span> <span class="hljs-string">'pull_request'</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>
      <span class="hljs-attr">packages:</span> <span class="hljs-string">write</span>

    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Docker</span> <span class="hljs-string">Buildx</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/setup-buildx-action@v2</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Log</span> <span class="hljs-string">in</span> <span class="hljs-string">to</span> <span class="hljs-string">Container</span> <span class="hljs-string">Registry</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/login-action@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">registry:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.REGISTRY</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.actor</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GITHUB_TOKEN</span> <span class="hljs-string">}}</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Extract</span> <span class="hljs-string">metadata</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">meta</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/metadata-action@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">images:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.REGISTRY</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.IMAGE_NAME</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">tags:</span> <span class="hljs-string">|
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">and</span> <span class="hljs-string">push</span> <span class="hljs-string">Docker</span> <span class="hljs-string">image</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/build-push-action@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">context:</span> <span class="hljs-string">.</span>
          <span class="hljs-attr">push:</span> <span class="hljs-literal">true</span>
          <span class="hljs-attr">tags:</span> <span class="hljs-string">${{</span> <span class="hljs-string">steps.meta.outputs.tags</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">labels:</span> <span class="hljs-string">${{</span> <span class="hljs-string">steps.meta.outputs.labels</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">cache-from:</span> <span class="hljs-string">type=gha</span>
          <span class="hljs-attr">cache-to:</span> <span class="hljs-string">type=gha,mode=max</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Generate</span> <span class="hljs-string">SBOM</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">anchore/sbom-action@v0</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">image:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.REGISTRY</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.IMAGE_NAME</span> <span class="hljs-string">}}:${{</span> <span class="hljs-string">github.sha</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">format:</span> <span class="hljs-string">spdx-json</span>
          <span class="hljs-attr">output-file:</span> <span class="hljs-string">sbom.spdx.json</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">SBOM</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">sbom</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">sbom.spdx.json</span>
</div></code></pre>
<h3 id="53-explication-du-workflow">5.3 Explication du workflow</h3>
<p><strong>Job 1 - security-analysis :</strong></p>
<ul>
<li>Lint du Dockerfile avec Hadolint</li>
</ul>
<p><strong>Job 2 - build-and-scan :</strong></p>
<ul>
<li>Build de l'image Docker</li>
<li>Scan avec Trivy (export SARIF)</li>
<li>Upload des résultats dans Security</li>
<li>Security Gate (échec si CRITICAL/HIGH)</li>
</ul>
<p><strong>Job 3 - push-image :</strong></p>
<ul>
<li>Ne s'exécute que si les scans passent</li>
<li>Push vers GHCR</li>
<li>Génération du SBOM (Software Bill of Materials)</li>
</ul>
<hr>
<h2 id="%C3%A9tape-6--am%C3%A9liorer-le-dockerfile-pour-la-s%C3%A9curit%C3%A9">Étape 6 : Améliorer le Dockerfile pour la Sécurité</h2>
<h3 id="61-dockerfile-s%C3%A9curis%C3%A9">6.1 Dockerfile sécurisé</h3>
<p>Remplacer le Dockerfile actuel :</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Utiliser une version spécifique (pas latest)</span>
<span class="hljs-keyword">FROM</span> nginx:<span class="hljs-number">1.25</span>.<span class="hljs-number">3</span>-alpine

<span class="hljs-comment"># Métadonnées</span>
<span class="hljs-keyword">LABEL</span><span class="bash"> maintainer=<span class="hljs-string">"TP DevOps"</span></span>
<span class="hljs-keyword">LABEL</span><span class="bash"> description=<span class="hljs-string">"Application DevOps sécurisée"</span></span>
<span class="hljs-keyword">LABEL</span><span class="bash"> org.opencontainers.image.source=<span class="hljs-string">"https://github.com/[username]/[repo]"</span></span>

<span class="hljs-comment"># Créer un utilisateur non-root</span>
<span class="hljs-keyword">RUN</span><span class="bash"> addgroup -g 1000 -S appgroup &amp;&amp; \
    adduser -u 1000 -S appuser -G appgroup</span>

<span class="hljs-comment"># Installer uniquement les dépendances nécessaires</span>
<span class="hljs-keyword">RUN</span><span class="bash"> apk add --no-cache \
    ca-certificates \
    &amp;&amp; rm -rf /var/cache/apk/*</span>

<span class="hljs-comment"># Copier la configuration Nginx</span>
<span class="hljs-keyword">COPY</span><span class="bash"> --chown=appuser:appgroup nginx/nginx.conf /etc/nginx/conf.d/default.conf</span>

<span class="hljs-comment"># Copier les fichiers de l'application</span>
<span class="hljs-keyword">COPY</span><span class="bash"> --chown=appuser:appgroup src/ /usr/share/nginx/html/</span>

<span class="hljs-comment"># Définir les permissions appropriées</span>
<span class="hljs-keyword">RUN</span><span class="bash"> chown -R appuser:appgroup /usr/share/nginx/html &amp;&amp; \
    chmod -R 755 /usr/share/nginx/html</span>

<span class="hljs-comment"># Modifier les permissions pour nginx</span>
<span class="hljs-keyword">RUN</span><span class="bash"> touch /var/run/nginx.pid &amp;&amp; \
    chown -R appuser:appgroup /var/run/nginx.pid &amp;&amp; \
    chown -R appuser:appgroup /var/cache/nginx</span>

<span class="hljs-comment"># Passer à l'utilisateur non-root</span>
<span class="hljs-keyword">USER</span> appuser

<span class="hljs-comment"># Exposer le port</span>
<span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span>

<span class="hljs-comment"># Health check</span>
<span class="hljs-keyword">HEALTHCHECK</span><span class="bash"> --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --quiet --tries=1 --spider http://localhost:8080/ || <span class="hljs-built_in">exit</span> 1</span>

<span class="hljs-comment"># Commande de démarrage</span>
<span class="hljs-keyword">CMD</span><span class="bash"> [<span class="hljs-string">"nginx"</span>, <span class="hljs-string">"-g"</span>, <span class="hljs-string">"daemon off;"</span>]</span>
</div></code></pre>
<h3 id="62-adapter-nginxconf">6.2 Adapter nginx.conf</h3>
<p>Modifier <code>nginx/nginx.conf</code> :</p>
<pre class="hljs"><code><div><span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">8080</span>;
    <span class="hljs-attribute">server_name</span> localhost;
    <span class="hljs-attribute">root</span> /usr/share/nginx/html;
    <span class="hljs-attribute">index</span> index.html;

    <span class="hljs-comment"># Configuration pour SPA</span>
    <span class="hljs-attribute">location</span> / {
        <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.html;
    }

    <span class="hljs-comment"># Headers de sécurité renforcés</span>
    <span class="hljs-attribute">add_header</span> X-Frame-Options <span class="hljs-string">"DENY"</span> always;
    <span class="hljs-attribute">add_header</span> X-Content-Type-Options <span class="hljs-string">"nosniff"</span> always;
    <span class="hljs-attribute">add_header</span> X-XSS-Protection <span class="hljs-string">"1; mode=block"</span> always;
    <span class="hljs-attribute">add_header</span> Referrer-Policy <span class="hljs-string">"strict-origin-when-cross-origin"</span> always;
    <span class="hljs-attribute">add_header</span> Content-Security-Policy <span class="hljs-string">"default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"</span> always;

    <span class="hljs-comment"># Désactiver les méthodes HTTP non nécessaires</span>
    <span class="hljs-attribute">if</span> (<span class="hljs-variable">$request_method</span> !<span class="hljs-regexp">~ ^(GET|HEAD|POST)$</span> ) {
        <span class="hljs-attribute">return</span> <span class="hljs-number">444</span>;
    }

    <span class="hljs-comment"># Compression</span>
    <span class="hljs-attribute">gzip</span> <span class="hljs-literal">on</span>;
    <span class="hljs-attribute">gzip_types</span> text/plain text/css application/json application/javascript text/xml application/xml;
    <span class="hljs-attribute">gzip_min_length</span> <span class="hljs-number">1000</span>;

    <span class="hljs-comment"># Cache pour les assets</span>
    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* \.(jpg|jpeg|png|gif|ico|css|js)$</span> {
        <span class="hljs-attribute">expires</span> <span class="hljs-number">1y</span>;
        <span class="hljs-attribute">add_header</span> Cache-Control <span class="hljs-string">"public, immutable"</span>;
    }

    <span class="hljs-comment"># Masquer la version de Nginx</span>
    <span class="hljs-attribute">server_tokens</span> <span class="hljs-literal">off</span>;
}
</div></code></pre>
<hr>
<h2 id="%C3%A9tape-7--tester-le-pipeline-s%C3%A9curis%C3%A9">Étape 7 : Tester le Pipeline Sécurisé</h2>
<h3 id="71-commit-et-push">7.1 Commit et push</h3>
<pre class="hljs"><code><div>git add .
git commit -m <span class="hljs-string">"Add DevSecOps: Trivy, Hadolint, secure Dockerfile"</span>
git push origin main
</div></code></pre>
<h3 id="72-observer-lex%C3%A9cution">7.2 Observer l'exécution</h3>
<ol>
<li>Onglet <strong>Actions</strong></li>
<li>Trois jobs doivent s'exécuter dans l'ordre :
<ul>
<li>security-analysis</li>
<li>build-and-scan</li>
<li>push-image</li>
</ul>
</li>
</ol>
<h3 id="73-analyser-les-r%C3%A9sultats">7.3 Analyser les résultats</h3>
<p><strong>Si des vulnérabilités HIGH/CRITICAL sont trouvées :</strong></p>
<ul>
<li>Le job build-and-scan échoue</li>
<li>Le job push-image ne s'exécute pas</li>
<li>L'image n'est pas publiée</li>
</ul>
<p><strong>Consulter les résultats :</strong></p>
<ul>
<li><strong>Security</strong> &gt; <strong>Code scanning alerts</strong></li>
<li>Voir les vulnérabilités Trivy détectées</li>
</ul>
<hr>
<h2 id="%C3%A9tape-8--corriger-les-vuln%C3%A9rabilit%C3%A9s">Étape 8 : Corriger les Vulnérabilités</h2>
<h3 id="81-analyser-les-alertes">8.1 Analyser les alertes</h3>
<p>Dans Security &gt; Code scanning :</p>
<ul>
<li>Identifier les vulnérabilités CRITICAL et HIGH</li>
<li>Noter les CVE associés</li>
<li>Identifier les packages concernés</li>
</ul>
<h3 id="82-mettre-%C3%A0-jour-limage-de-base">8.2 Mettre à jour l'image de base</h3>
<p>Si des vulnérabilités sont dans nginx:alpine :</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Utiliser la dernière version stable</span>
<span class="hljs-keyword">FROM</span> nginx:<span class="hljs-number">1.25</span>.<span class="hljs-number">4</span>-alpine
</div></code></pre>
<h3 id="83-corriger-les-d%C3%A9pendances-npm">8.3 Corriger les dépendances npm</h3>
<p>Mettre à jour <code>package.json</code> :</p>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"devops-tp-docker"</span>,
  <span class="hljs-attr">"version"</span>: <span class="hljs-string">"1.0.1"</span>,
  <span class="hljs-attr">"description"</span>: <span class="hljs-string">"TP DevSecOps avec Docker"</span>,
  <span class="hljs-attr">"scripts"</span>: {
    <span class="hljs-attr">"test"</span>: <span class="hljs-string">"echo \"No tests yet\""</span>
  },
  <span class="hljs-attr">"dependencies"</span>: {
    <span class="hljs-attr">"express"</span>: <span class="hljs-string">"^4.18.2"</span>,
    <span class="hljs-attr">"lodash"</span>: <span class="hljs-string">"^4.17.21"</span>
  },
  <span class="hljs-attr">"devDependencies"</span>: {
    <span class="hljs-attr">"eslint"</span>: <span class="hljs-string">"^8.55.0"</span>
  }
}
</div></code></pre>
<h3 id="84-accepter-les-pr-dependabot">8.4 Accepter les PR Dependabot</h3>
<ol>
<li>Aller dans <strong>Pull requests</strong></li>
<li>Voir les PR créées par Dependabot</li>
<li>Review et merge chaque PR</li>
</ol>
<h3 id="85-re-tester">8.5 Re-tester</h3>
<pre class="hljs"><code><div>git add .
git commit -m <span class="hljs-string">"Fix: Update dependencies to resolve vulnerabilities"</span>
git push origin main
</div></code></pre>
<p>Le pipeline devrait maintenant passer en vert.</p>
<hr>
<h2 id="%C3%A9tape-9--scanner-une-image-localement">Étape 9 : Scanner une Image Localement</h2>
<h3 id="91-installer-trivy-localement">9.1 Installer Trivy localement</h3>
<p><strong>macOS :</strong></p>
<pre class="hljs"><code><div>brew install trivy
</div></code></pre>
<p><strong>Linux :</strong></p>
<pre class="hljs"><code><div>wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
<span class="hljs-built_in">echo</span> <span class="hljs-string">"deb https://aquasecurity.github.io/trivy-repo/deb <span class="hljs-variable">$(lsb_release -sc)</span> main"</span> | sudo tee -a /etc/apt/sources.list.d/trivy.list
sudo apt-get update
sudo apt-get install trivy
</div></code></pre>
<h3 id="92-scanner-limage-locale">9.2 Scanner l'image locale</h3>
<pre class="hljs"><code><div>docker build -t devops-tp-docker:<span class="hljs-built_in">local</span> .
trivy image devops-tp-docker:<span class="hljs-built_in">local</span>
</div></code></pre>
<h3 id="93-scanner-avec-seuil">9.3 Scanner avec seuil</h3>
<pre class="hljs"><code><div>trivy image --severity HIGH,CRITICAL --<span class="hljs-built_in">exit</span>-code 1 devops-tp-docker:<span class="hljs-built_in">local</span>
</div></code></pre>
<h3 id="94-g%C3%A9n%C3%A9rer-un-rapport">9.4 Générer un rapport</h3>
<pre class="hljs"><code><div>trivy image --format json --output report.json devops-tp-docker:<span class="hljs-built_in">local</span>
</div></code></pre>
<hr>
<h2 id="%C3%A9tape-10--ajouter-un-badge-de-s%C3%A9curit%C3%A9">Étape 10 : Ajouter un Badge de Sécurité</h2>
<h3 id="101-modifier-readmemd">10.1 Modifier README.md</h3>
<pre class="hljs"><code><div><span class="hljs-section"># TP DevSecOps avec Docker</span>

![<span class="hljs-string">Build and Scan</span>](<span class="hljs-link">https://github.com/[username]/devops-tp-docker-[nom]/actions/workflows/docker-deploy.yml/badge.svg</span>)
![<span class="hljs-string">CodeQL</span>](<span class="hljs-link">https://github.com/[username]/devops-tp-docker-[nom]/actions/workflows/codeql-analysis.yml/badge.svg</span>)

<span class="hljs-section">## Pipeline DevSecOps</span>

Ce projet implémente un pipeline CI/CD sécurisé pour Docker avec :
<span class="hljs-bullet">
- </span>Analyse statique du code (CodeQL)
<span class="hljs-bullet">- </span>Lint du Dockerfile (Hadolint)
<span class="hljs-bullet">- </span>Scan de l'image Docker (Trivy)
<span class="hljs-bullet">- </span>Scan des dépendances (Dependabot)
<span class="hljs-bullet">- </span>Secret Scanning
<span class="hljs-bullet">- </span>Security Gates (blocage sur vulnérabilités critiques)
<span class="hljs-bullet">- </span>SBOM (Software Bill of Materials)

<span class="hljs-section">## Architecture de Sécurité</span>

</div></code></pre>
<p>Code → SAST → Hadolint → Build → Trivy → Security Gates → GHCR</p>
<pre class="hljs"><code><div>
## Sécurité de l'Image

- Image de base : nginx:alpine (version spécifique)
- Utilisateur non-root
- Headers de sécurité renforcés
- Health checks
- Pas de secrets dans l'image

## Exécution Locale

```bash
docker pull ghcr.io/[username]/devops-tp-docker-[nom]:main
docker run -p 8080:8080 ghcr.io/[username]/devops-tp-docker-[nom]:main
</div></code></pre>
<p>Accéder à : http://localhost:8080</p>
<h2 id="scan-de-s%C3%A9curit%C3%A9-local">Scan de Sécurité Local</h2>
<pre class="hljs"><code><div>trivy image ghcr.io/[username]/devops-tp-docker-[nom]:main
</div></code></pre>
<pre class="hljs"><code><div>
---

## Résultats Attendus

À la fin de ce TP, vous devez avoir :

**Pipeline DevSecOps complet :**
- CodeQL pour l'analyse du code source
- Hadolint pour le lint du Dockerfile
- Trivy pour le scan des images
- Dependabot pour les dépendances
- Secret Scanning activé
- Security Gates fonctionnels

**Image Docker sécurisée :**
- Utilisateur non-root
- Image de base à jour
- Dépendances corrigées
- Headers de sécurité
- Pas de vulnérabilités HIGH/CRITICAL

**Visibilité :**
- Dashboard Security complet
- Alertes automatiques
- SBOM généré
- Badges dans README

---

## Commandes Trivy Avancées

```bash
# Scan d'un filesystem
trivy fs .

# Scan avec ignoré des unfixed
trivy image --ignore-unfixed nginx:alpine

# Scan de config Kubernetes
trivy config k8s-manifest.yaml

# Scan avec template personnalisé
trivy image --format template --template &quot;@contrib/html.tpl&quot; -o report.html nginx:alpine

# Liste des vulnérabilités par package
trivy image --list-all-pkgs nginx:alpine
</div></code></pre>
<hr>
<h2 id="m%C3%A9triques-de-s%C3%A9curit%C3%A9">Métriques de Sécurité</h2>
<p>Pour mesurer l'efficacité :</p>
<p><strong>Métriques d'images :</strong></p>
<ul>
<li>Nombre de vulnérabilités par sévérité</li>
<li>Taille de l'image</li>
<li>Nombre de layers</li>
<li>Âge de l'image de base</li>
</ul>
<p><strong>Métriques de pipeline :</strong></p>
<ul>
<li>Temps de scan</li>
<li>Taux de blocage des Security Gates</li>
<li>Fréquence des builds</li>
</ul>
<p><strong>Métriques de correction :</strong></p>
<ul>
<li>MTTR (Mean Time To Remediate)</li>
<li>Nombre de PR Dependabot mergées</li>
<li>Temps entre détection et correction</li>
</ul>
<hr>
<h2 id="troubleshooting">Troubleshooting</h2>
<p><strong>Trivy échoue mais pas de vulnérabilités visibles</strong></p>
<ul>
<li>Consulter les logs détaillés du job</li>
<li>Vérifier les seuils (CRITICAL, HIGH)</li>
<li>Certaines vulnérabilités peuvent être dans les dépendances transitives</li>
</ul>
<p><strong>Hadolint bloque sur des warnings</strong></p>
<ul>
<li>Ajuster failure-threshold dans .hadolint.yaml</li>
<li>Ignorer des règles spécifiques si justifié</li>
</ul>
<p><strong>Image ne démarre pas après changements sécurité</strong></p>
<ul>
<li>Vérifier les permissions des fichiers</li>
<li>Vérifier que nginx peut écrire dans les dossiers nécessaires</li>
<li>Tester localement d'abord</li>
</ul>
<p><strong>SBOM non généré</strong></p>
<ul>
<li>Vérifier les permissions du workflow</li>
<li>L'image doit être poussée avant génération SBOM</li>
</ul>
<hr>
<h2 id="aller-plus-loin">Aller Plus Loin</h2>
<p><strong>Signature des images</strong></p>
<ul>
<li>Cosign pour signer les images Docker</li>
<li>Vérification de signature avant déploiement</li>
</ul>
<p><strong>Runtime Security</strong></p>
<ul>
<li>Falco pour la détection d'anomalies</li>
<li>AppArmor/SELinux profiles</li>
</ul>
<p><strong>Policy as Code</strong></p>
<ul>
<li>OPA (Open Policy Admission) pour Kubernetes</li>
<li>Policies de sécurité automatisées</li>
</ul>
<p><strong>Scan continu</strong></p>
<ul>
<li>Re-scan périodique des images en production</li>
<li>Alertes sur nouvelles CVE</li>
</ul>
<hr>
<p>TP 2 - Sécuriser le Pipeline Docker CI/CD</p>

</body>
</html>
